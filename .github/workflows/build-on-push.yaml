# This workflow file build the Godot project for multiple target systems.
name: Build

on:
  [push, pull_request]

env:
  GODOT_VERSION: 4.3.0
  OPENXR_VENDORS_VERSION: 3.1.0-stable

jobs:
  # Matrix-job to create builds
  build:
    name: Building for ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        include:
          # Export for Windows
          - name: ðŸ Windows
            os: windows-latest
            platform: windows
            export-preset: Windows
            export-type: release
            export-folder: build/windows

          # Export for Linux
          - name: ðŸ§ Linux
            os: ubuntu-22.04
            platform: linux
            export-preset: Linux
            export-type: release
            export-folder: build/linux

          # Export for Meta Quest
          - name: ðŸ¤– Meta Quest
            os: ubuntu-22.04
            platform: android
            export-preset: MetaQuest
            export-type: debug
            export-args: --install-android-build-template
            export-folder: build/metaquest

          # Export for Pico
          - name: ðŸ¤– Pico
            os: ubuntu-22.04
            platform: android
            export-preset: Pico
            export-type: debug
            export-args: --install-android-build-template
            export-folder: build/pico

          # Export for Magic Leap
          - name: ðŸ¤– Magic Leap
            os: ubuntu-22.04
            platform: android
            export-preset: MagicLeap
            export-type: debug
            export-args: --install-android-build-template
            export-folder: build/magicleap

          # Export for Vive
          - name: ðŸ¤– Vive
            os: ubuntu-22.04
            platform: android
            export-preset: Vive
            export-type: debug
            export-args: --install-android-build-template
            export-folder: build/vive

          # Export for WebXR
          - name: ðŸŒ WebXR
            os: ubuntu-22.04
            platform: web
            export-preset: WebXR
            export-type: release
            export-folder: build/webxr

    steps:
      # Check out the repository
      - name: Checkout
        uses: actions/checkout@v4

      # Install the OpenXR Vendors Plugin
      - name: Install OpenXR Vendors Plugin
        shell: bash
        run: |
          curl -L -O https://github.com/GodotVR/godot_openxr_vendors/releases/download/${{ env.OPENXR_VENDORS_VERSION }}/godotopenxrvendorsaddon.zip
          unzip -o godotopenxrvendorsaddon.zip -d godotopenxrvendorsaddon
          mkdir addons
          mv godotopenxrvendorsaddon/asset/addons/godotopenxrvendors addons/godotopenxrvendors
          rm godotopenxrvendorsaddon.zip
          rm -rf godotopenxrvendorsaddon

      # If targeting android then install JDK
      - name: Set up JDK 17
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # If targeting android then install Android SDK
      - name: Setup Android SDK
        if: matrix.platform == 'android'
        uses: android-actions/setup-android@v3

      # If targeting android then install Android SDK Packages
      - name: Install Android SDK Packages
        if: matrix.platform == 'android'
        run: >
          sdkmanager
          "platform-tools"
          "build-tools;34.0.0"
          "platforms;android-34"
          "cmdline-tools;latest"
          "cmake;3.10.2.4988404"
          "ndk;23.2.8568313"

      # Setup Godot
      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      # Import Godot Project
      - name: Initial Godot Import
        shell: bash
        run: |
          godot --headless --import || exit 0

      # Export project
      - name: Export Godot Project
        shell: bash
        run: >
          godot
          --headless
          ${{ matrix.export-args }}
          --export-${{ matrix.export-type }} ${{ matrix.export-preset }}

      # Compress project
      - name: Compress project
        run: |
          cd ${{ matrix.export-folder }}
          7z a -tzip ${{ matrix.export-preset }}.zip *.* -x'!.gitignore'

      # Upload artifacts
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.export-preset }}-Artifacts
          path: ${{ matrix.export-folder }}/${{ matrix.export-preset }}.zip

  # Job to publish release
  release:
    name: Publish Release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
    runs-on: ubuntu-22.04
    needs: build
    permissions:
      contents: write

    steps:
      # Download artifacts
      - name: Download all workflow run artifacts
        uses: actions/download-artifact@v4

      # Publish release
      - uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: '*-Artifacts/*.zip'
          omitNameDuringUpdate: true
          omitBodyDuringUpdate: true
          token: ${{ secrets.GITHUB_TOKEN }}
